<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="manager">

	<select id="user_list" parameterType="usersVO" resultType="usersVO">
		SELECT * FROM 
			( SELECT row_number() OVER(ORDER BY TOTAL.report_count DESC) AS TOTAL_NO, TOTAL.* 
  			FROM  ( SELECT u.*, bc.booth_count, bb.booth_ban_count, rc.review_count, ac.ask_count,
				rpc.report_count, rpbc.report_ban_count, s.selling_number, s.seller_black FROM users u
   				LEFT JOIN (SELECT seller_id, COUNT(*) AS booth_count FROM booth GROUP BY seller_id) AS bc ON u.user_id = bc.seller_id
    			LEFT JOIN (SELECT seller_id, COUNT(*) AS booth_ban_count FROM booth WHERE booth_ban = 1 GROUP BY seller_id) AS bb ON u.user_id = bb.seller_id
    			LEFT JOIN (SELECT user_id, COUNT(*) AS review_count FROM review GROUP BY user_id) AS rc ON u.user_id = rc.user_id
    			LEFT JOIN (SELECT user_id, COUNT(*) AS ask_count FROM ask GROUP BY user_id) AS ac ON u.user_id = ac.user_id
    			LEFT JOIN (SELECT user_id, COUNT(*) AS report_count FROM report GROUP BY user_id) AS rpc ON u.user_id = rpc.user_id
    			LEFT JOIN (SELECT user_id, COUNT(*) AS report_ban_count FROM report where report_lie = 1 group by user_id) AS rpbc ON u.user_id = rpc.user_id
    			LEFT JOIN seller s ON u.user_id = s.user_id
    			WHERE u.user_black = 0
		  ) AS TOTAL
		) AS TOTAL2
		WHERE TOTAL2.TOTAL_NO BETWEEN ${start} AND ${end};
	</select>
	
	<select id="user_search" parameterType="usersVO" resultType="usersVO">
	    SELECT * FROM 
	        (SELECT row_number() OVER(ORDER BY TOTAL.report_count DESC) AS TOTAL_NO, TOTAL.* 
	          FROM  (SELECT u.*, bc.booth_count, bb.booth_ban_count, rc.review_count, ac.ask_count,
	            rpc.report_count, rpbc.report_ban_count, s.selling_number, s.seller_black 
	            FROM users u
	            LEFT JOIN (SELECT seller_id, COUNT(*) AS booth_count FROM booth GROUP BY seller_id) AS bc ON u.user_id = bc.seller_id
	            LEFT JOIN (SELECT seller_id, COUNT(*) AS booth_ban_count FROM booth WHERE booth_ban = 1 GROUP BY seller_id) AS bb ON u.user_id = bb.seller_id
	            LEFT JOIN (SELECT user_id, COUNT(*) AS review_count FROM review GROUP BY user_id) AS rc ON u.user_id = rc.user_id
	            LEFT JOIN (SELECT user_id, COUNT(*) AS ask_count FROM ask GROUP BY user_id) AS ac ON u.user_id = ac.user_id
	            LEFT JOIN (SELECT user_id, COUNT(*) AS report_count FROM report GROUP BY user_id) AS rpc ON u.user_id = rpc.user_id
	            LEFT JOIN (SELECT user_id, COUNT(*) AS report_ban_count FROM report WHERE report_lie = 1 GROUP BY user_id) AS rpbc ON u.user_id = rpc.user_id
	            LEFT JOIN seller s ON u.user_id = s.user_id
	            WHERE u.user_black = 0;
	            <choose>
	                <when test="type == 'name'">
	                    AND user_name LIKE CONCAT('%', #{keyword}, '%')
	                </when>
	                <when test="type == 'email'">
	                    AND u.user_id LIKE CONCAT('%', #{keyword}, '%')
	                </when>
	                <when test="type == 'tel'">
	                    AND user_tel LIKE CONCAT('%', #{keyword}, '%')
	                </when>
	                <when test="type == 'created'">
	                    AND user_created_at LIKE CONCAT('%', #{keyword}, '%')
	                </when>
	                <when test="type == 'updated'">
	                    AND user_updated_at LIKE CONCAT('%', #{keyword}, '%')
	                </when>
	                <when test="type == 'fp'">
	                    <if test="user_role == 'seller'">
	                        AND booth_ban_count LIKE CONCAT('%', #{keyword}, '%')
	                    </if>
	                    <if test="user_role == 'consumer'">
	                        AND report_ban_count LIKE CONCAT('%', #{keyword}, '%')
	                    </if>
	                </when>
	            </choose>
	          ) AS TOTAL
	        ) AS TOTAL2
	        WHERE TOTAL2.TOTAL_NO BETWEEN ${start} AND ${end};
	</select>
		
	<select id="user_count" parameterType="usersVO" resultType="int">
	    SELECT COUNT(*) FROM 
	        (SELECT row_number() OVER(ORDER BY TOTAL.report_count DESC) AS TOTAL_NO, TOTAL.* 
	          FROM  (SELECT u.*, bc.booth_count, bb.booth_ban_count, rc.review_count, ac.ask_count,
	            rpc.report_count, rpbc.report_ban_count, s.selling_number, s.seller_black 
	            FROM users u
	            LEFT JOIN (SELECT seller_id, COUNT(*) AS booth_count FROM booth GROUP BY seller_id) AS bc ON u.user_id = bc.seller_id
	            LEFT JOIN (SELECT seller_id, COUNT(*) AS booth_ban_count FROM booth WHERE booth_ban = 1 GROUP BY seller_id) AS bb ON u.user_id = bb.seller_id
	            LEFT JOIN (SELECT user_id, COUNT(*) AS review_count FROM review GROUP BY user_id) AS rc ON u.user_id = rc.user_id
	            LEFT JOIN (SELECT user_id, COUNT(*) AS ask_count FROM ask GROUP BY user_id) AS ac ON u.user_id = ac.user_id
	            LEFT JOIN (SELECT user_id, COUNT(*) AS report_count FROM report GROUP BY user_id) AS rpc ON u.user_id = rpc.user_id
	            LEFT JOIN (SELECT user_id, COUNT(*) AS report_ban_count FROM report WHERE report_lie = 1 GROUP BY user_id) AS rpbc ON u.user_id = rpc.user_id
	            LEFT JOIN seller s ON u.user_id = s.user_id
	            WHERE u.user_black = 0
	            <choose>
	                <when test="type == 'name'">
	                    AND user_name LIKE CONCAT('%', #{keyword}, '%')
	                </when>
	                <when test="type == 'email'">
	                    AND u.user_id LIKE CONCAT('%', #{keyword}, '%')
	                </when>
	                <when test="type == 'tel'">
	                    AND user_tel LIKE CONCAT('%', #{keyword}, '%')
	                </when>
	                <when test="type == 'created'">
	                    AND user_created_at LIKE CONCAT('%', #{keyword}, '%')
	                </when>
	                <when test="type == 'updated'">
	                    AND user_updated_at LIKE CONCAT('%', #{keyword}, '%')
	                </when>
	                <when test="type == 'fp'">
	                    <if test="user_role == 'seller'">
	                        AND booth_ban_count LIKE CONCAT('%', #{keyword}, '%')
	                    </if>
	                    <if test="user_role == 'consumer'">
	                        AND report_ban_count LIKE CONCAT('%', #{keyword}, '%')
	                    </if>
	                </when>
	            </choose>
	          ) AS TOTAL
	        ) AS TOTAL2
	</select>
	
	<select id="ban_user_list" parameterType="usersVO" resultType="usersVO">
		SELECT * FROM 
			( SELECT row_number() OVER(ORDER BY TOTAL.report_count DESC) AS TOTAL_NO, TOTAL.* 
  			FROM  ( SELECT u.*, bc.booth_count, bb.booth_ban_count, rc.review_count, ac.ask_count,
				rpc.report_count, rpbc.report_ban_count, s.selling_number, s.seller_black FROM users u
   				LEFT JOIN (SELECT seller_id, COUNT(*) AS booth_count FROM booth GROUP BY seller_id) AS bc ON u.user_id = bc.seller_id
    			LEFT JOIN (SELECT seller_id, COUNT(*) AS booth_ban_count FROM booth WHERE booth_ban = 1 GROUP BY seller_id) AS bb ON u.user_id = bb.seller_id
    			LEFT JOIN (SELECT user_id, COUNT(*) AS review_count FROM review GROUP BY user_id) AS rc ON u.user_id = rc.user_id
    			LEFT JOIN (SELECT user_id, COUNT(*) AS ask_count FROM ask GROUP BY user_id) AS ac ON u.user_id = ac.user_id
    			LEFT JOIN (SELECT user_id, COUNT(*) AS report_count FROM report GROUP BY user_id) AS rpc ON u.user_id = rpc.user_id
    			LEFT JOIN (SELECT user_id, COUNT(*) AS report_ban_count FROM report where report_lie = 1 group by user_id) AS rpbc ON u.user_id = rpc.user_id
    			LEFT JOIN seller s ON u.user_id = s.user_id
    			WHERE u.user_black = 1
		  ) AS TOTAL
		) AS TOTAL2
		WHERE TOTAL2.TOTAL_NO BETWEEN ${start} AND ${end};
	</select>
	
	<select id="ban_user_search" parameterType="usersVO" resultType="usersVO">
	    SELECT * FROM 
	        (SELECT row_number() OVER(ORDER BY TOTAL.report_count DESC) AS TOTAL_NO, TOTAL.* 
	          FROM  (SELECT u.*, bc.booth_count, bb.booth_ban_count, rc.review_count, ac.ask_count,
	            rpc.report_count, rpbc.report_ban_count, s.selling_number, s.seller_black 
	            FROM users u
	            LEFT JOIN (SELECT seller_id, COUNT(*) AS booth_count FROM booth GROUP BY seller_id) AS bc ON u.user_id = bc.seller_id
	            LEFT JOIN (SELECT seller_id, COUNT(*) AS booth_ban_count FROM booth WHERE booth_ban = 1 GROUP BY seller_id) AS bb ON u.user_id = bb.seller_id
	            LEFT JOIN (SELECT user_id, COUNT(*) AS review_count FROM review GROUP BY user_id) AS rc ON u.user_id = rc.user_id
	            LEFT JOIN (SELECT user_id, COUNT(*) AS ask_count FROM ask GROUP BY user_id) AS ac ON u.user_id = ac.user_id
	            LEFT JOIN (SELECT user_id, COUNT(*) AS report_count FROM report GROUP BY user_id) AS rpc ON u.user_id = rpc.user_id
	            LEFT JOIN (SELECT user_id, COUNT(*) AS report_ban_count FROM report WHERE report_lie = 1 GROUP BY user_id) AS rpbc ON u.user_id = rpc.user_id
	            LEFT JOIN seller s ON u.user_id = s.user_id
	            WHERE u.user_black = 1
	            <choose>
	                <when test="type == 'name'">
	                    AND user_name LIKE CONCAT('%', #{keyword}, '%')
	                </when>
	                <when test="type == 'email'">
	                    AND u.user_id LIKE CONCAT('%', #{keyword}, '%')
	                </when>
	                <when test="type == 'tel'">
	                    AND user_tel LIKE CONCAT('%', #{keyword}, '%')
	                </when>
	                <when test="type == 'created'">
	                    AND user_created_at LIKE CONCAT('%', #{keyword}, '%')
	                </when>
	                <when test="type == 'updated'">
	                    AND user_updated_at LIKE CONCAT('%', #{keyword}, '%')
	                </when>
	                <when test="type == 'fp'">
	                    <if test="user_role == 'seller'">
	                        AND booth_ban_count LIKE CONCAT('%', #{keyword}, '%')
	                    </if>
	                    <if test="user_role == 'consumer'">
	                        AND report_ban_count LIKE CONCAT('%', #{keyword}, '%')
	                    </if>
	                </when>
	            </choose>
	          ) AS TOTAL
	        ) AS TOTAL2
	        WHERE TOTAL2.TOTAL_NO BETWEEN ${start} AND ${end};
	</select>
		
	<select id="ban_user_count" parameterType="usersVO" resultType="int">
	    SELECT COUNT(*) FROM 
	        (SELECT row_number() OVER(ORDER BY TOTAL.report_count DESC) AS TOTAL_NO, TOTAL.* 
	          FROM  (SELECT u.*, bc.booth_count, bb.booth_ban_count, rc.review_count, ac.ask_count,
	            rpc.report_count, rpbc.report_ban_count, s.selling_number, s.seller_black 
	            FROM users u
	            LEFT JOIN (SELECT seller_id, COUNT(*) AS booth_count FROM booth GROUP BY seller_id) AS bc ON u.user_id = bc.seller_id
	            LEFT JOIN (SELECT seller_id, COUNT(*) AS booth_ban_count FROM booth WHERE booth_ban = 1 GROUP BY seller_id) AS bb ON u.user_id = bb.seller_id
	            LEFT JOIN (SELECT user_id, COUNT(*) AS review_count FROM review GROUP BY user_id) AS rc ON u.user_id = rc.user_id
	            LEFT JOIN (SELECT user_id, COUNT(*) AS ask_count FROM ask GROUP BY user_id) AS ac ON u.user_id = ac.user_id
	            LEFT JOIN (SELECT user_id, COUNT(*) AS report_count FROM report GROUP BY user_id) AS rpc ON u.user_id = rpc.user_id
	            LEFT JOIN (SELECT user_id, COUNT(*) AS report_ban_count FROM report WHERE report_lie = 1 GROUP BY user_id) AS rpbc ON u.user_id = rpc.user_id
	            LEFT JOIN seller s ON u.user_id = s.user_id
	            WHERE u.user_black = 1
	            <choose>
	                <when test="type == 'name'">
	                    AND user_name LIKE CONCAT('%', #{keyword}, '%')
	                </when>
	                <when test="type == 'email'">
	                    AND u.user_id LIKE CONCAT('%', #{keyword}, '%')
	                </when>
	                <when test="type == 'tel'">
	                    AND user_tel LIKE CONCAT('%', #{keyword}, '%')
	                </when>
	                <when test="type == 'created'">
	                    AND user_created_at LIKE CONCAT('%', #{keyword}, '%')
	                </when>
	                <when test="type == 'updated'">
	                    AND user_updated_at LIKE CONCAT('%', #{keyword}, '%')
	                </when>
	                <when test="type == 'fp'">
	                    <if test="user_role == 'seller'">
	                        AND booth_ban_count LIKE CONCAT('%', #{keyword}, '%')
	                    </if>
	                    <if test="user_role == 'consumer'">
	                        AND report_ban_count LIKE CONCAT('%', #{keyword}, '%')
	                    </if>
	                </when>
	            </choose>
	          ) AS TOTAL
	        ) AS TOTAL2
	</select>
		
	<select id="report_list" parameterType="reportVO" resultType="reportVO">
		select * from 
		(select row_number() OVER(order by TOTAL.REPORT_NO desc) as TOTAL_NO, TOTAL.* 
		from(
			select report.*, booth.booth_name, festival.fstv_title
	    	FROM report
	    	JOIN booth ON report.booth_no = booth.booth_no
	    	JOIN festival ON report.fstv_no = festival.fstv_no) TOTAL    
	    ) TOTAL2 	
	    WHERE TOTAL2.total_no between ${start} and ${end};
	</select>
	
	<select id="report_search" parameterType="pagingVO" resultType="reportVO">
		select * from 
	    (select row_number() OVER(order by TOTAL3.REPORT_NO desc) as TOTAL_NO2, TOTAL3.*
	    from (SELECT report.*, booth.booth_name, festival.fstv_title
	    FROM report
	    JOIN booth ON report.booth_no = booth.booth_no
	    JOIN festival ON report.fstv_no = festival.fstv_no
	    <where>
	        <if test="type == 'no'">
	            report_no = #{keyword}
	        </if>
	        <if test="type == 'title'">
	            report_title LIKE CONCAT('%', #{keyword}, '%')
	        </if>
	        <if test="type == 'email'">
	            user_id LIKE CONCAT('%', #{keyword}, '%')
	        </if>
	        <if test="type == 'booth'">
	            booth_name LIKE CONCAT('%', #{keyword}, '%')
	        </if>
	        <if test="type == 'created'">
	            report_date LIKE CONCAT('%', #{keyword}, '%')
	        </if>
	    </where>
	    ) TOTAL3) TOTAL4
	    WHERE TOTAL4.total_no2 between ${start} and ${end};
	</select>
	
	<select id="report_count" parameterType="pagingVO" resultType="int">
		select count(*) from 
	    (select row_number() OVER(order by TOTAL3.REPORT_NO desc) as TOTAL_NO2, TOTAL3.*
	    from (SELECT report.*, booth.booth_name, festival.fstv_title
	    FROM report
	    JOIN booth ON report.booth_no = booth.booth_no
	    JOIN festival ON report.fstv_no = festival.fstv_no
	    <where>
	        <if test="type == 'no'">
	            report_no = #{keyword}
	        </if>
	        <if test="type == 'title'">
	            report_title LIKE CONCAT('%', #{keyword}, '%')
	        </if>
	        <if test="type == 'email'">
	            user_id LIKE CONCAT('%', #{keyword}, '%')
	        </if>
	        <if test="type == 'booth'">
	            booth_name LIKE CONCAT('%', #{keyword}, '%')
	        </if>
	        <if test="type == 'created'">
	            report_date LIKE CONCAT('%', #{keyword}, '%')
	        </if>
	    </where>
	    ) TOTAL3) TOTAL4
	</select>
	
	<select id="report_detail" parameterType="reportVO" resultType="reportVO">
		SELECT report.*, booth.booth_name, festival.fstv_title
		FROM report
		JOIN booth ON report.booth_no = booth.booth_no
		JOIN festival ON report.fstv_no = festival.fstv_no
		WHERE report_no = #{report_no};
	</select>
	
	<select id="ask_list" parameterType="askVO" resultType="askVO">
		SELECT * FROM ask
		ORDER BY ask_no DESC;
	</select>
	
	<select id="ask_search" parameterType="askVO" resultType="askVO">
		SELECT * FROM ask
	    <where>
	        <if test="type == 'no'">
	            ask_no = #{word}
	        </if>
	        <if test="type == 'title'">
	            ask_title LIKE CONCAT('%', #{word}, '%')
	        </if>
	        <if test="type == 'email'">
	            user_id LIKE CONCAT('%', #{word}, '%')
	        </if>
	        <if test="type == 'created'">
	            ask_created_at LIKE CONCAT('%', #{word}, '%')
	        </if>
	    </where>
	    ORDER BY ask_no DESC;
	</select>
	
	<select id="ask_detail" parameterType="askVO" resultType="askVO">
		SELECT * FROM ask
		WHERE ask_no = #{ask_no}
		ORDER BY ask_no DESC;
	</select>
	
	<select id="total_count" parameterType="pagingVO" resultType="int">
	    SELECT COUNT(*) FROM
	    <choose>
	        <when test="table == 'report'">
	            report
	        </when>
	        <when test="table == 'users'">
	            users u
	            LEFT JOIN seller s ON u.user_id = s.user_id
	            WHERE (u.user_black = 0 OR s.seller_black = 0)
	        </when>
	        <when test="table == 'ban_users'">
	            users u
	            LEFT JOIN seller s ON u.user_id = s.user_id
	            WHERE (u.user_black = 1 OR s.seller_black = 1)
	        </when>
	    </choose>
	</select>
	
</mapper>
